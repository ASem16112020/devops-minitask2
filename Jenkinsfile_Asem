pipeline {
    // –ì–ª–æ–±–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª—é–±–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∞–≥–µ–Ω—Ç, –µ—Å–ª–∏ –∏–Ω–æ–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ stage.
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (workspace) —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏.
    agent any 

    environment {
        DOCKER_IMAGE = 'asem505rav/python-devops:latest' 
        // –í Declarative Pipeline 'Dockerfile' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–æ—Ä–Ω–µ, 
        // –µ—Å–ª–∏ –≤—ã –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ buildArgs. –ü–µ—Ä–µ–∏–º–µ–Ω—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏.
        DOCKERFILE_PATH = 'Dockerfile_asem'
        
        // –î–æ–±–∞–≤–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ kubectl (—Å–º. –Ω–æ–≤—ã–π —ç—Ç–∞–ø –Ω–∏–∂–µ)
        KUBECTL_ARCH = 'arm64' // –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø–æ –≤–∞—à–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ª–æ–≥–∞–º
    }

    stages {
        // --- –≠–¢–ê–ü 1: LINTING (–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Docker) ---
        stage('1. Python Lint & Syntax Check') {
            // –ó–∞–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —ç—Ç–∞–ø –≤–Ω—É—Ç—Ä–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
            // Jenkins –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—Å—Ç–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.
            agent {
                docker {
                    image 'python:3.9-slim'
                    args '-u root' // –ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
                }
            }
            steps {
                echo 'Starting Python linting inside Docker container...'
                sh '''
                    # 1. –£—Å—Ç–∞–Ω–æ–≤–∏–º Flake8 (–∏–ª–∏ pylint) –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏–Ω—Ç–∏–Ω–≥–∞
                    pip install flake8
                    
                    # 2. –í—ã–ø–æ–ª–Ω–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–¥–∞
                    flake8 app.py --max-line-length=120
                '''
                echo '‚úÖ Python linting and syntax check passed.'
            }
        }
        
        // --- –≠–¢–ê–ü 2: –°–ë–û–†–ö–ê –û–ë–†–ê–ó–ê ---
        stage('2. Docker Build') {
            steps {
                echo 'Building Docker image...'
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ Dockerfile
                sh "docker build -f ${DOCKERFILE_PATH} -t ${DOCKER_IMAGE} ."
                echo "‚úÖ Image ${DOCKER_IMAGE} built successfully."
            }
        }
        
        // --- –ù–û–í–´–ô –≠–¢–ê–ü: –£–°–¢–ê–ù–û–í–ö–ê KUBECTL ---
        stage('3. Install Kubectl') {
            steps {
                echo '‚¨áÔ∏è Installing kubectl for deployment simulation...'
                sh '''
                    KUBE_VERSION=$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)
                    curl -LO "https://storage.googleapis.com/kubernetes-release/release/$KUBE_VERSION/bin/linux/${KUBECTL_ARCH}/kubectl"
                    chmod +x kubectl
                    
                    # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –∫–∞—Ç–∞–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ PATH (–Ω–∞–ø—Ä–∏–º–µ—Ä, /usr/local/bin/)
                    mv kubectl /usr/local/bin/
                    
                    kubectl version --client
                '''
                echo '‚úÖ Kubectl is installed.'
            }
        }
        
        // --- –≠–¢–ê–ü 4: –ò–ú–ò–¢–ê–¶–ò–Ø –î–ï–ü–õ–û–Ø (Dry Run) ---
        stage('4. Deploy Simulation (Dry Run)') {
            steps {
                echo 'üöÄ Simulating deployment to Kubernetes...'
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º kubectl, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ
                sh "kubectl apply -f k8s_manifests/deployment_Asem.yaml --dry-run=client"
                echo '‚úÖ Kubernetes manifests are valid.'
            }
        }
    }
}